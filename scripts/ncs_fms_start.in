#!/bin/bash 
#
#      -*- OpenSAF  -*-
#
# (C) Copyright 2008 The OpenSAF Foundation
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE. This file and program are licensed
# under the GNU Lesser General Public License Version 2.1, February 1999.
# The complete license can be accessed from the following location:
# http://opensource.org/licenses/lgpl-license.php
# See the Copying file included with the OpenSAF distribution for full
# licensing terms.
#
# Author(s): Vishal Soni (vishal.soni@emerson.com)
#
#

source "@sysconfdir@/@PACKAGE_NAME@/script.conf"

#
# FMS AMF instantiate script
#
#PATH=$PATH:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/opensaf/controller/bin
#PIDPATH=/var/run
PIDFILE=fms.pid
DAEMON=ncs_fms
DESC="Fault management service"
#BINPATH=/opt/opensaf/controller/bin
#FMS_SCRIPT=/opt/opensaf/controller/scripts/fms_script

#
#To start ncs_fms from gdb
#FMS_SCRIPT=xterm -e /usr/bin/gdb /opt/opensaf/controller/bin/ncs_fms
#

#FMS_HA_COMP_NAMED_PIPE=/tmp/fms_ha_comp_named_pipe
#FMS_HA_ENV_HEALTHCHECK_KEY="BAD9"

export FMS_CONF_PATH="$SYSCONFDIR/fms.conf"

echo "Executing FMS HA init-script..."
echo "comp name = $SA_AMF_COMPONENT_NAME"
echo "healthcheck key = $FMS_HA_ENV_HEALTHCHECK_KEY"
echo "NCS_STDOUTS_PATH=$NCS_STDOUTS_PATH"
#
# Set environment variables
#
function fms_set_env_var
{

	# Check for environment variable for shelf number.
	#if [ "$SHELF_NUMBER" = "" ] ; then
        #        SHELF_NUMBER=`cat /etc/opt/opensaf/shelf_id`
        #        export SHELF_NUMBER
	#fi

	# Check for environment variable for slot number.
	if [ "$SLOT_NUMBER" = "" ] ; then
		SLOT_NUMBER=`cat "$SYSCONFDIR/slot_id"`
                export SLOT_NUMBER
	fi

	# Check for environment variable for site number.
	if [ "$SITE_NUMBER" = "" ] ; then
		export SITE_NUMBER=0x0F
	fi

	# Check for environment variable for site number.
	if [ "$PAYLOAD_BLADES" = "" ] ; then
		export PAYLOAD_BLADES="3.$SITE_NUMBER 4.$SITE_NUMBER 5.$SITE_NUMBER 6.$SITE_NUMBER 7.$SITE_NUMBER 8.$SITE_NUMBER 9.$SITE_NUMBER 10.$SITE_NUMBER 11.$SITE_NUMBER 12.$SITE_NUMBER 13.$SITE_NUMBER 14.$SITE_NUMBER 15.$SITE_NUMBER 16.$SITE_NUMBER"
	fi
	
}


#
# Create the named pipe if not exist FMS_HA_COMP_NAMED_PIPE
#
if test -p $FMS_HA_COMP_NAMED_PIPE
then
   echo "$FMS_HA_COMP_NAMED_PIPE is already existing"
else
   mkfifo -m 0666 $FMS_HA_COMP_NAMED_PIPE # mode 0666
fi

#
# push the component name and HC key into the named pipe (running in the backgroud)
# Do not ouput tailing new line (-n) and enable escape sequences (-e)
#

#
# check for the PID availability
#
if test -f "$PIDPATH/$PIDFILE"
then
   l_pid=`cat "$PIDPATH/$PIDFILE"`
fi

if [ "$l_pid" ]
then 
   echo "ncs_fms daemon is already running"
   echo -n -e "$SA_AMF_COMPONENT_NAME|$FMS_HA_ENV_HEALTHCHECK_KEY" > $FMS_HA_COMP_NAMED_PIPE &
else 
   echo "Starting $DESC: $BINPATH/$DAEMON";		

#
# Set env
#
   fms_set_env_var
   "$BINPATH/ncs_fms" > "$NCS_STDOUTS_PATH/ncs_fms.log" 2>&1 &
   sleep 1s
   if test -f "$PIDPATH/$PIDFILE" 
   then
      l_pid=`cat "$PIDPATH/$PIDFILE"`
   fi

   if [ "$l_pid" ]
   then 
      echo "ncs_fms daemon restarted successfully with PID $l_pid"
   echo -n -e "$SA_AMF_COMPONENT_NAME|$FMS_HA_ENV_HEALTHCHECK_KEY" > $FMS_HA_COMP_NAMED_PIPE &
   else
      echo "Sorry ncs_fms daemon start failed, startup script failed"
   fi
fi

exit 0
